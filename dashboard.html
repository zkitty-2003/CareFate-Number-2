<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareFate - Dashboard</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=2">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
</head>

<body class="theme-working page-dashboard">
    <!-- Loading Screen (Initial) -->
    <div id="loadingOverlay"
        style="position:fixed; inset:0; background:#0f172a; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem; color:#6366f1;"></i>
    </div>

    <!-- Background -->
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display:none; opacity:0; transition: opacity 0.5s;">

        <!-- Scrollable Area -->
        <div class="scrollable-content">
            <!-- Header -->
            <div class="dash-header">
                <div class="user-info">
                    <h1>สวัสดี, <span id="usernameDisplay">User</span></h1>
                    <p id="dateDisplay">วันจันทร์ที่ 1 มกราคม</p>
                </div>
                <div class="profile-pic" onclick="location.href='settings.html'">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>

            <!-- Daily Insight (Fate) -->
            <div style="padding: 1rem 1.5rem 0.5rem;">
                <div
                    style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 1.2rem; display: flex; align-items: flex-start; gap: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div
                        style="background: rgba(168, 85, 247, 0.2); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-wand-magic-sparkles" style="color: #d8b4fe; font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <h3 style="color: white; font-size: 1rem; margin: 0 0 0.4rem 0; font-weight: 600;">
                            ดวงสุขภาพวันนี้
                        </h3>
                        <p style="color: #cbd5e1; font-size: 0.85rem; line-height: 1.5; margin: 0;">
                            "สีมงคลคือ<span style="color:#f472b6; font-weight:600;">สีชมพู</span>..
                            วันนี้อากาศเปลี่ยนแปลง
                            ดูแลสุขภาพคอและจิบน้ำอุ่นบ่อยๆ นะคะ"
                        </p>
                    </div>
                </div>
            </div>

            <!-- Features Section -->
            <div class="section-title">
                บริการของคุณ
                <span style="font-size:0.8rem; color:var(--text-muted); cursor:pointer;"
                    onclick="window.location.href='feature-selection.html'"><i class="fa-solid fa-pen"></i> แก้ไข</span>
            </div>

            <div class="features-grid" id="dashboardFeatures">
                <!-- Dynamic Features will be loaded here -->
            </div>
        </div>
        <!-- End Scrollable Area -->

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="location.href='dashboard.html'"><i class="fa-solid fa-house"></i>
            </div>
            <div class="nav-item" onclick="location.href='history.html'"><i class="fa-solid fa-chart-pie"></i></div>
            <div class="nav-item"><i class="fa-solid fa-comment-dots"></i></div>
            <div class="nav-item"><i class="fa-solid fa-gear" onclick="location.href='settings.html'"></i></div>
        </div>
    </div>

    <script>
        // Inline JS for Dashboard Logic
        const SUPABASE_URL = 'https://rjszmmogkiblqojikcow.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_RoboGAH-Nqm1dQi3ORqYUQ_StZ7uU4Y';
        let _supabase;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: { session } } = await _supabase.auth.getSession();

                if (!session) {
                    window.location.href = 'index.html'; // Redirect if not logged in
                    return;
                }

                const user = session.user;
                // console.log("Dashboard User:", user); 

                // Check Local Avatar Fallback (Immediate)
                const localAvatar = localStorage.getItem(`avatar_${user.id}`);
                if (localAvatar) {
                    const picContainer = document.querySelector('.profile-pic');
                    if (picContainer) {
                        picContainer.innerHTML = `<img src="${localAvatar}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    }
                }

                // Fetch Profile for Theme & Features
                const { data: profile } = await _supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    // Fallback to metadata if profile columns are empty (Robustness)
                    const theme = profile.theme || user.user_metadata.theme || 'working';

                    // Robust parsing for features (handling array or string representation)
                    let features = [];
                    const rawFeatures = profile.features || user.user_metadata.features;

                    if (Array.isArray(rawFeatures)) {
                        features = rawFeatures;
                    } else if (typeof rawFeatures === 'string') {
                        try {
                            // Try JSON parse if it's a JSON string
                            features = JSON.parse(rawFeatures);
                        } catch (e) {
                            // If it's a postgres array string like {a,b,c}
                            features = rawFeatures.replace(/[{}"']/g, '').split(',');
                        }
                    }

                    const username = profile.username || user.user_metadata.username;

                    applyTheme(theme);
                    renderFeatures(features);
                    updateUserInfo(username);

                    // Supabase Avatar Logic (Wins over local if exists)
                    if (profile.avatar_url) {
                        const picContainer = document.querySelector('.profile-pic');
                        if (picContainer) {
                            picContainer.innerHTML = `<img src="${profile.avatar_url}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                        }
                    }
                } else {
                    // Fallback fully to metadata
                    applyTheme(user.user_metadata.theme);
                    renderFeatures(user.user_metadata.features || []);
                    updateUserInfo(user.user_metadata.username);
                }

                // Show Dashboard
                document.getElementById('loadingOverlay').style.display = 'none';
                const dash = document.getElementById('dashboardContent');
                dash.style.display = 'flex';
                // Trigger reflow
                dash.offsetHeight;
                dash.style.opacity = '1';

            } catch (e) {
                console.error("Dashboard Load Error:", e);
                alert("เกิดข้อผิดพลาดในการโหลดข้อมูล");
            }
        });

        function updateUserInfo(name) {
            document.getElementById('usernameDisplay').textContent = name || 'ผู้ใช้งาน';

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            document.getElementById('dateDisplay').textContent = today.toLocaleDateString('th-TH', options);
        }

        function applyTheme(themeId) {
            const body = document.body;
            // Remove old theme classes
            body.classList.remove('theme-youth', 'theme-working', 'theme-elder');

            if (themeId) {
                body.classList.add(`theme-${themeId}`);

                // Dynamic colors based on theme
                let primaryColor;
                if (themeId === 'youth') primaryColor = '#ec4899'; // Pink
                else if (themeId === 'elder') primaryColor = '#10b981'; // Green
                else primaryColor = '#6366f1'; // Blue/Purple (Default)

                document.documentElement.style.setProperty('--primary-color', primaryColor);
            }
        }

        function renderFeatures(featureList) {
            const grid = document.getElementById('dashboardFeatures');
            grid.innerHTML = '';

            if (!featureList || featureList.length === 0) {
                grid.innerHTML = '<p style="grid-column: span 2; text-align:center; color:#94a3b8;">ยังไม่ได้เลือกฟีเจอร์</p>';
                return;
            }

            // Feature Metadata map (Duplicate from register.js but simplified)
            const featureMap = {
                'medication': { title: 'ทานยา', icon: 'fa-pills' },
                'excretion': { title: 'การขับถ่าย', icon: 'fa-toilet' },
                'sleep': { title: 'การนอน', icon: 'fa-bed' },
                'goals': { title: 'เป้าหมาย', icon: 'fa-bullseye' },
                'exercise': { title: 'ออกกำลังกาย', icon: 'fa-dumbbell' },
                'period': { title: 'รอบเดือน', icon: 'fa-droplet' },
                'vehicle': { title: 'ยานพาหนะ', icon: 'fa-motorcycle' },
                'diet': { title: 'อาหาร', icon: 'fa-utensils' },
                'appointment': { title: 'นัดหมอ', icon: 'fa-user-doctor' }
            };

            featureList.forEach(fid => {
                const meta = featureMap[fid];
                if (!meta) return;

                const item = document.createElement('div');
                item.className = 'feature-item';
                if (meta.title === 'การขับถ่าย') {
                    item.onclick = () => location.href = 'feature-excretion.html';
                } else if (meta.title === 'การนอน') {
                    item.onclick = () => location.href = 'feature-sleep.html';
                } else if (meta.title === 'ออกกำลังกาย') {
                    item.onclick = () => location.href = 'feature-exercise.html';
                } else if (meta.title === 'ทานยา') {
                    item.onclick = () => location.href = 'feature-medication.html';
                } else if (meta.title === 'เป้าหมาย') {
                    item.onclick = () => location.href = 'feature-goals.html';
                } else {
                    item.onclick = () => alert(`เข้าสู่เมนู: ${meta.title} (Coming Soon)`);
                }
                item.innerHTML = `
                    <i class="fa-solid ${meta.icon}"></i>
                    <span>${meta.title}</span>
                `;
                grid.appendChild(item);
            });

            // Add "More" button always
            const more = document.createElement('div');
            more.className = 'feature-item';
            more.style.opacity = '0.6';
            more.onclick = () => window.location.href = 'feature-selection.html';
            more.innerHTML = `
                <i class="fa-solid fa-plus"></i>
                <span>เพิ่ม</span>
            `;
            grid.appendChild(more);
        }

        async function logout() {
            if (confirm('ต้องการออกจากระบบ?')) {
                await _supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // --- Daily Fate Logic ---
        function generateDailyFate() {
            const todayStr = new Date().toDateString(); // Unique key per day
            const savedFate = localStorage.getItem('carefate_daily_' + todayStr);

            if (savedFate) {
                renderFate(JSON.parse(savedFate));
                return;
            }

            // Data Pools
            const colors = [
                { name: 'สีชมพู', hex: '#f472b6' },
                { name: 'สีเขียวเหนี่ยวทรัพย์', hex: '#34d399' },
                { name: 'สีฟ้าสดใส', hex: '#60a5fa' },
                { name: 'สีส้ม', hex: '#fb923c' },
                { name: 'สีม่วง', hex: '#a78bfa' }
            ];

            const tips = [
                "วันนี้อากาศเปลี่ยนแปลง ดูแลสุขภาพคอและจิบน้ำอุ่นบ่อยๆ นะคะ",
                "ดวงสุขภาพดีมาก! แต่อย่าลืมยืดเส้นยืดสายระหว่างวันด้วยนะ",
                "ระวังเรื่องการทานของหวานวันนี้ อาจทำให้อ่อนเพลียได้ง่าย",
                "วันนี้เหมาะกับการเริ่มต้นออกกำลังกายเบาๆ ลองเดินเล่นสัก 15 นาทีดูสิ",
                "ความเครียดอาจถามหา ลองหาเวลาพักสายตาสักนิด ชีวิตจะสดใสขึ้น"
            ];

            // Randomize
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];

            const fateData = {
                colorName: randomColor.name,
                colorHex: randomColor.hex,
                tip: randomTip
            };

            // Save and Render
            localStorage.setItem('carefate_daily_' + todayStr, JSON.stringify(fateData));
            renderFate(fateData);
        }

        function renderFate(data) {
            const container = document.getElementById('dailyFateText');
            if (!container) return;

            container.innerHTML = `
            "สีมงคลคือ<span style="color:${data.colorHex}; font - weight: 600; ">${data.colorName}</span>.. ${data.tip}"
            `;
        }

        // Call logic
        generateDailyFate();
    </script>
</body>

</html>