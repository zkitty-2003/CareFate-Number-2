<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareFate - Dashboard</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=3">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>


<body class="theme-working page-dashboard">
    <!-- Loading Screen (Initial) -->
    <div id="loadingOverlay"
        style="position:fixed; inset:0; background:#0f172a; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem; color:#6366f1;"></i>
    </div>

    <!-- Background -->
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display:none; opacity:0; transition: opacity 0.5s;">

        <!-- Scrollable Area -->
        <div class="scrollable-content">
            <!-- Header -->
            <div class="dash-header">
                <div class="user-info">
                    <h1>สวัสดี, <span id="usernameDisplay">User</span></h1>
                    <p id="dateDisplay">วันจันทร์ที่ 1 มกราคม</p>
                </div>

                <div style="display:flex; align-items:center; gap:0.8rem;">
                    <!-- Notification Icon -->
                    <div onclick="location.href='notification-history.html'"
                        style="position: relative; cursor: pointer; background:var(--card-bg); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--card-border); box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fa-solid fa-bell" style="font-size: 1.2rem; color: var(--text-color);"></i>
                        <div id="notif-badge"
                            style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; display: none;">
                        </div>
                    </div>

                    <div class="profile-pic" onclick="location.href='settings.html'">
                        <i class="fa-solid fa-user"></i>
                    </div>
                </div>
            </div>

            <!-- Daily Insight (Fate) -->
            <div style="padding: 1rem 1.5rem 0.5rem;">
                <div
                    style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 1.2rem; display: flex; align-items: flex-start; gap: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div
                        style="background: rgba(168, 85, 247, 0.2); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-wand-magic-sparkles" style="color: #d8b4fe; font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <h3 style="color: white; font-size: 1rem; margin: 0 0 0.4rem 0; font-weight: 600;">
                            ดวงสุขภาพวันนี้
                        </h3>
                        <p id="horoscopeText" style="color: #cbd5e1; font-size: 0.85rem; line-height: 1.5; margin: 0;">
                            "กำลังโหลดดวงสุขภาพของคุณ..."
                        </p>
                    </div>
                </div>
            </div>

            <!-- Features Section -->
            <div class="section-title">
                บริการของคุณ
                <span style="font-size:0.8rem; color:var(--text-muted); cursor:pointer;"
                    onclick="window.location.href='feature-selection.html'"><i class="fa-solid fa-pen"></i> แก้ไข</span>
            </div>

            <div class="features-grid" id="dashboardFeatures">
                <!-- Dynamic Features will be loaded here -->
            </div>
        </div>
        <!-- End Scrollable Area -->

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="location.href='dashboard.html'"><i class="fa-solid fa-house"></i>
            </div>
            <div class="nav-item" onclick="location.href='history.html'"><i class="fa-solid fa-chart-pie"></i></div>
            <div class="nav-item" onclick="location.href='chatbot.html'"><i class="fa-solid fa-comment-dots"></i></div>
            <div class="nav-item"><i class="fa-solid fa-gear" onclick="location.href='settings.html'"></i></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rjszmmogkiblqojikcow.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_RoboGAH-Nqm1dQi3ORqYUQ_StZ7uU4Y';
        let _supabase;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Update Date
                const dateStr = new Date().toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('dateDisplay').textContent = dateStr;

                // Default Variables (Defined in outer scope to be accessible later)
                let theme = 'working';
                let username = 'User';
                let features = [];
                let avatarUrl = null;

                // Check Supabase
                if (window.supabase) {
                    _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    const { data: { session } } = await _supabase.auth.getSession();

                    if (!session) {
                        window.location.href = 'index.html';
                        return;
                    }

                    const user = session.user;

                    // Fetch Profile Data
                    let { data: profile, error } = await _supabase
                        .from('profiles')
                        .select('theme, username, avatar_url, features')
                        .eq('id', user.id)
                        .single();

                    // Logic to determine Theme, Username, Features, Avatar
                    // Priority: Profile Table > User Metadata > Default

                    // 1. Theme
                    if (profile && profile.theme) theme = profile.theme;
                    else if (user.user_metadata.theme) theme = user.user_metadata.theme;

                    // 2. Username (Fix: Check metadata.username NOT full_name)
                    if (profile && profile.username) username = profile.username;
                    else if (user.user_metadata.username) username = user.user_metadata.username;
                    else if (user.user_metadata.full_name) username = user.user_metadata.full_name;

                    // 3. Avatar
                    if (profile && profile.avatar_url) avatarUrl = profile.avatar_url;

                    // 4. Features
                    let rawFeatures = [];
                    if (profile && profile.features) rawFeatures = profile.features;
                    else if (user.user_metadata.features) rawFeatures = user.user_metadata.features;

                    if (Array.isArray(rawFeatures)) features = rawFeatures;
                    else if (typeof rawFeatures === 'string') {
                        try { features = JSON.parse(rawFeatures); } catch (e) { features = []; }
                    }

                    // Render Avatar (Priority: Supabase > LocalStorage > Default)
                    if (!avatarUrl) {
                        avatarUrl = localStorage.getItem(`avatar_${user.id}`);
                    }

                    const pic = document.querySelector('.profile-pic');
                    if (pic) {
                        if (avatarUrl) {
                            pic.innerHTML = `<img src="${avatarUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                        } else {
                            pic.innerHTML = `<i class="fa-solid fa-user"></i>`;
                        }
                    }
                } // End Supabase Check

                applyTheme(theme);
                updateUserInfo(username);
                renderFeatures(features);

                // Load Horoscope
                loadHoroscope(theme);

            } catch (e) {
                console.error("Init Error", e);
                // alert("Error loading dashboard");
            } finally {
                // ALWAYS Hide Loader (Remove from DOM to prevent blocking)
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) overlay.remove();

                    const dash = document.getElementById('dashboardContent');
                    dash.style.display = 'flex';
                    dash.style.zIndex = '10'; // Ensure content is above background
                    dash.style.position = 'relative';
                    dash.offsetHeight; // trigger reflow
                    dash.style.opacity = '1';
                }, 500);
            }
        });

        function updateUserInfo(name) {
            document.getElementById('usernameDisplay').textContent = name;
        }

        function applyTheme(themeId) {
            document.body.classList.remove('theme-youth', 'theme-working', 'theme-elder');
            if (themeId) {
                document.body.classList.add(`theme-${themeId}`);
                let primaryColor = '#6366f1';
                if (themeId === 'youth') primaryColor = '#ec4899';
                if (themeId === 'elder') primaryColor = '#10b981';
                document.documentElement.style.setProperty('--primary-color', primaryColor);
            }
        }

        function renderFeatures(featureList) {
            const grid = document.getElementById('dashboardFeatures');
            grid.innerHTML = '';

            const featureMap = {
                'medication': { title: 'ทานยา', icon: 'fa-pills', link: 'feature-medication.html' },
                'excretion': { title: 'การขับถ่าย', icon: 'fa-toilet', link: 'feature-excretion.html' },
                'sleep': { title: 'การนอน', icon: 'fa-bed', link: 'feature-sleep.html' },
                'goals': { title: 'เป้าหมาย', icon: 'fa-bullseye', link: 'feature-goals.html' },
                'exercise': { title: 'ออกกำลังกาย', icon: 'fa-dumbbell', link: 'feature-exercise.html' },
                'period': { title: 'รอบเดือน', icon: 'fa-droplet', link: 'feature-period.html' },
                'vehicle': { title: 'ยานพาหนะ', icon: 'fa-motorcycle', link: 'feature-vehicle.html' },
                'diet': { title: 'อาหาร', icon: 'fa-utensils', link: 'feature-food.html' },
                'appointment': { title: 'นัดหมอ', icon: 'fa-user-doctor', link: 'feature-appointment.html' }
            };

            if (!featureList || featureList.length === 0) {
                grid.innerHTML = '<p style="grid-column: span 2; text-align:center; opacity:0.6;">เลือกฟีเจอร์ที่ต้องการใช้งานได้ที่ปุ่ม "แก้ไข"</p>';
            } else {
                featureList.forEach(fid => {
                    const meta = featureMap[fid];
                    if (!meta) return;
                    const item = document.createElement('div');
                    item.className = 'feature-item';
                    item.onclick = () => location.href = meta.link;
                    item.innerHTML = `<i class="fa-solid ${meta.icon}"></i><span>${meta.title}</span>`;
                    grid.appendChild(item);
                });
            }
            // Add "More" button always
            const more = document.createElement('div');
            more.className = 'feature-item';
            more.style.opacity = '0.6';
            more.onclick = () => window.location.href = 'feature-selection.html';
            more.innerHTML = `<i class="fa-solid fa-plus"></i><span>เพิ่ม</span>`;
            grid.appendChild(more);
        }

        async function loadHoroscope(theme) {
            const horoscopeText = document.getElementById('horoscopeText');
            // Check cache based on date to save API costs
            const todayKey = 'horoscope_' + new Date().toDateString();
            const cached = localStorage.getItem(todayKey);

            if (cached) {
                horoscopeText.innerHTML = `"${cached}"`;
                return;
            }

            horoscopeText.innerHTML = '<span style="opacity:0.7"><i class="fa-solid fa-circle-notch fa-spin"></i> กำลังถาม AI...</span>';

            try {
                const res = await fetch('http://localhost:8000/api/horoscope', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: theme })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    // Success!
                    horoscopeText.innerHTML = `"${data.horoscope}"`;
                    localStorage.setItem(todayKey, data.horoscope);
                } else {
                    // Show API Error from Server
                    horoscopeText.innerHTML = `<span style="color:#ef4444; font-size:0.8rem;">Error: ${data.message}</span>`;
                }
            } catch (e) {
                // Show Network Error
                console.warn("Horoscope API Failed", e);
                horoscopeText.innerHTML = `<span style="color:#ef4444; font-size:0.8rem;">Connection Failed: ${e.message}</span>`;
            }
        }
    </script>
    <script src="notifications.js"></script>
</body>

</html>